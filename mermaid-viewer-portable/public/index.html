<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mermaid Diagram Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        /* max-width: 1200px; */
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }
      .header {
        background: #2c3e50;
        color: white;
        padding: 20px;
        text-align: center;
      }
      .content {
        display: flex;
        height: calc(100vh - 120px);
      }
      .sidebar {
        width: 300px;
        background: #f8f9fa;
        border-right: 1px solid #dee2e6;
        overflow-y: auto;
      }
      .main {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        position: relative;
      }
      .main.full-width {
        padding: 0;
      }
      .main.full-width .diagram-container {
        margin: 0;
        border-radius: 0;
        border: none;
        min-height: calc(100vh - 120px);
      }
      .file-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .file-item {
        padding: 12px 20px;
        border-bottom: 1px solid #dee2e6;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .file-item:hover {
        background-color: #e9ecef;
      }
      .file-item.active {
        background-color: #007bff;
        color: white;
      }
      .file-item .file-name {
        font-weight: 500;
        margin-bottom: 4px;
      }
      .file-item .file-path {
        font-size: 12px;
        color: #6c757d;
      }
      .file-item.active .file-path {
        color: #e9ecef;
      }
      .folder-item {
        padding: 8px 20px;
        background: #e9ecef;
        border-bottom: 1px solid #dee2e6;
        cursor: pointer;
        font-weight: 600;
        color: #495057;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .folder-item:hover {
        background: #dee2e6;
      }
      .folder-item .folder-icon {
        margin-right: 8px;
        transition: transform 0.2s;
      }
      .folder-item.expanded .folder-icon {
        transform: rotate(90deg);
      }
      .folder-children {
        display: none;
        padding-left: 20px;
      }
      .folder-children.expanded {
        display: block;
      }
      .controls {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        gap: 10px;
      }
      .control-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: background-color 0.2s;
      }
      .control-btn:hover {
        background: #0056b3;
      }
      .control-btn.active {
        background: #28a745;
      }
      .zoom-controls {
        display: flex;
        align-items: center;
        gap: 5px;
        background: white;
        padding: 5px;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .zoom-btn {
        background: #6c757d;
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
      }
      .zoom-btn:hover {
        background: #5a6268;
      }
      .zoom-level {
        font-size: 12px;
        color: #495057;
        min-width: 40px;
        text-align: center;
      }
      .diagram-container {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 20px;
        margin-bottom: 20px;
      }
      .diagram-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
        color: #2c3e50;
      }
      .mermaid {
        text-align: center;
        transform-origin: center;
        transition: transform 0.3s ease;
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .mermaid svg {
        max-width: 100%;
        height: auto;
        display: block;
      }
      .mermaid:empty::after {
        content: "Loading diagram...";
        color: #6c757d;
        font-style: italic;
      }
      .loading {
        text-align: center;
        color: #6c757d;
        padding: 40px;
      }
      .error {
        color: #dc3545;
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 4px;
        padding: 15px;
        margin: 20px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Mermaid Diagram Viewer</h1>
        <p>Interactive diagram viewer for your project documentation</p>
      </div>
      <div class="content">
        <div class="sidebar">
          <ul class="file-list" id="fileList">
            <li class="loading">Loading diagrams...</li>
          </ul>
        </div>
        <div class="main" id="mainContent">
          <div class="controls">
            <button class="control-btn" id="fullWidthBtn">Full Width</button>
            <div class="zoom-controls">
              <button class="zoom-btn" id="zoomOutBtn">-</button>
              <span class="zoom-level" id="zoomLevel">100%</span>
              <button class="zoom-btn" id="zoomInBtn">+</button>
              <button class="zoom-btn" id="resetZoomBtn">Reset</button>
            </div>
          </div>
          <div class="loading">Select a diagram to view</div>
        </div>
      </div>
    </div>

    <script>
      let diagrams = [];
      let currentDiagram = null;
      let isFullWidth = false;
      let zoomLevel = 1;
      let folderStructure = {};
      let isLoading = false;

      // Initialize Mermaid
      mermaid.initialize({
        startOnLoad: false,
        theme: "default",
        securityLevel: "loose",
      });

      // Load diagrams list
      async function loadDiagrams() {
        try {
          const response = await fetch("/api/diagrams");
          diagrams = await response.json();
          buildFolderStructure();
          renderFileList();
          setupControls();
        } catch (error) {
          console.error("Error loading diagrams:", error);
          document.getElementById("fileList").innerHTML =
            '<li class="error">Error loading diagrams</li>';
        }
      }

      // Build hierarchical folder structure
      function buildFolderStructure() {
        folderStructure = {};

        diagrams.forEach((diagram) => {
          const pathParts = diagram.path.split("/");
          let current = folderStructure;

          // Build folder structure
          for (let i = 0; i < pathParts.length - 1; i++) {
            const part = pathParts[i];
            if (!current[part]) {
              current[part] = { _folders: {} };
            }
            current = current[part]._folders;
          }

          // Add file to the correct location
          const fileName = pathParts[pathParts.length - 1];
          if (fileName) {
            current[fileName] = diagram;
          }
        });

        console.log("Built folder structure:", folderStructure);
      }

      // Render file list with folder structure
      function renderFileList() {
        const fileList = document.getElementById("fileList");
        fileList.innerHTML = "";

        if (Object.keys(folderStructure).length === 0) {
          fileList.innerHTML = '<li class="loading">No diagrams found</li>';
          return;
        }

        renderFolder(folderStructure, fileList, "");
      }

      // Render folder recursively
      function renderFolder(folder, container, path) {
        Object.keys(folder).forEach((key) => {
          if (key.startsWith("_")) return;

          const item = folder[key];
          if (item && typeof item === "object" && item._folders !== undefined) {
            // It's a folder
            const folderLi = document.createElement("li");
            folderLi.className = "folder-item";
            folderLi.innerHTML = `
               <span>
                 <span class="folder-icon">â–¶</span>
                 ${key}
               </span>
             `;

            const childrenContainer = document.createElement("ul");
            childrenContainer.className = "folder-children";

            folderLi.addEventListener("click", (e) => {
              e.stopPropagation();
              folderLi.classList.toggle("expanded");
              childrenContainer.classList.toggle("expanded");
            });

            container.appendChild(folderLi);
            container.appendChild(childrenContainer);

            // Render subfolders and files
            renderFolder(item._folders, childrenContainer, path + key + "/");
          } else if (item && item.name && item.path) {
            // It's a file
            const fileLi = document.createElement("li");
            fileLi.className = "file-item";
            fileLi.innerHTML = `
               <div class="file-name">${item.name}</div>
               <div class="file-path">${item.path}</div>
             `;
            fileLi.addEventListener("click", () =>
              loadDiagram(item, diagrams.indexOf(item))
            );
            container.appendChild(fileLi);
          }
        });
      }

      // Load and render diagram
      async function loadDiagram(diagram, index) {
        try {
          console.log("Loading diagram:", diagram);

          // Prevent multiple simultaneous loads
          if (isLoading) {
            console.log("Already loading, skipping...");
            return;
          }

          if (currentDiagram && currentDiagram.path === diagram.path) {
            console.log("Diagram already loaded, skipping...");
            return;
          }

          isLoading = true;

          // Update active file - safely handle missing elements
          const fileItems = document.querySelectorAll(".file-item");
          fileItems.forEach((item) => item.classList.remove("active"));

          if (fileItems[index]) {
            fileItems[index].classList.add("active");
          }

          // Show loading state
          const mainContent = document.getElementById("mainContent");
          mainContent.innerHTML = `
             <div class="diagram-container">
               <div class="diagram-title">${diagram.name}</div>
               <div class="loading">Loading diagram...</div>
             </div>
           `;

          console.log("DOM cleared, starting fetch...");

          // Load diagram content
          const response = await fetch(`/api/diagram/${diagram.path}`);
          const data = await response.json();

          if (data.error) {
            throw new Error(data.error);
          }

          console.log(
            "Diagram content loaded:",
            data.content.substring(0, 100) + "..."
          );
          console.log("Content type:", data.type || "mermaid");

          currentDiagram = diagram;
          renderDiagram(diagram, data.content, data.type || "mermaid");

          isLoading = false;
        } catch (error) {
          console.error("Error loading diagram:", error);
          isLoading = false;
          document.getElementById("mainContent").innerHTML = `
                     <div class="error">
                         <strong>Error loading diagram:</strong> ${error.message}
                     </div>
                 `;
        }
      }

      // Setup control event listeners
      function setupControls() {
        document
          .getElementById("fullWidthBtn")
          .addEventListener("click", toggleFullWidth);
        document
          .getElementById("zoomInBtn")
          .addEventListener("click", () => adjustZoom(0.1));
        document
          .getElementById("zoomOutBtn")
          .addEventListener("click", () => adjustZoom(-0.1));
        document
          .getElementById("resetZoomBtn")
          .addEventListener("click", resetZoom);
      }

      // Toggle full width mode
      function toggleFullWidth() {
        const main = document.getElementById("mainContent");
        const btn = document.getElementById("fullWidthBtn");

        isFullWidth = !isFullWidth;
        main.classList.toggle("full-width", isFullWidth);
        btn.classList.toggle("active", isFullWidth);
        btn.textContent = isFullWidth ? "Normal Width" : "Full Width";
      }

      // Adjust zoom level
      function adjustZoom(delta) {
        zoomLevel = Math.max(0.1, Math.min(3, zoomLevel + delta));
        updateZoom();
      }

      // Reset zoom
      function resetZoom() {
        zoomLevel = 1;
        updateZoom();
      }

      // Update zoom display and apply transform
      function updateZoom() {
        const diagramElement = document.querySelector(".mermaid");
        if (diagramElement) {
          diagramElement.style.transform = `scale(${zoomLevel})`;
        }

        const zoomLevelElement = document.getElementById("zoomLevel");
        if (zoomLevelElement) {
          zoomLevelElement.textContent = Math.round(zoomLevel * 100) + "%";
        }
      }

      // Render diagram
      function renderDiagram(diagram, content, contentType = "mermaid") {
        const mainContent = document.getElementById("mainContent");

        // Clear any existing content first
        mainContent.innerHTML = "";

        if (diagram.type === "mermaid") {
          // Create the container structure
          const container = document.createElement("div");
          container.className = "diagram-container";

          const title = document.createElement("div");
          title.className = "diagram-title";
          title.textContent = diagram.name;

          const diagramDiv = document.createElement("div");
          diagramDiv.className = "mermaid";
          diagramDiv.id = `diagram-${Date.now()}`;

          container.appendChild(title);
          container.appendChild(diagramDiv);
          mainContent.appendChild(container);

          if (contentType === "svg") {
            // Serve pre-built SVG directly
            console.log("Rendering pre-built SVG");
            console.log("SVG length:", content.length);
            console.log("SVG preview:", content.substring(0, 200) + "...");

            diagramDiv.innerHTML = content;
            updateZoom();

            console.log("Pre-built SVG rendered successfully");
          } else {
            // Render Mermaid diagram on-the-fly (fallback)
            console.log(
              "Rendering Mermaid diagram with content:",
              content.substring(0, 200) + "..."
            );

            // Store reference to prevent garbage collection
            const elementRef = diagramDiv;
            const containerRef = container;

            // Use a timeout to ensure DOM is stable
            setTimeout(() => {
              // Double-check element still exists
              if (!elementRef || !elementRef.parentNode) {
                console.warn("Element removed before rendering, skipping...");
                return;
              }

              mermaid
                .render(`diagram-${Date.now()}`, content)
                .then(({ svg }) => {
                  console.log("Mermaid diagram rendered successfully");
                  console.log("SVG length:", svg.length);
                  console.log("SVG preview:", svg.substring(0, 200) + "...");

                  // Check if the element still exists before updating
                  if (
                    elementRef &&
                    elementRef.parentNode &&
                    containerRef &&
                    containerRef.parentNode
                  ) {
                    elementRef.innerHTML = svg;
                    elementRef.offsetHeight; // Force reflow
                    updateZoom();

                    console.log(
                      "Diagram element after render:",
                      elementRef.innerHTML.length,
                      "characters"
                    );
                  } else {
                    console.warn(
                      "Diagram element was removed during rendering"
                    );
                    // Try to re-render by calling loadDiagram again
                    console.log("Attempting to re-render...");
                    setTimeout(() => {
                      const currentIndex = diagrams.findIndex(
                        (d) => d.path === diagram.path
                      );
                      if (currentIndex !== -1) {
                        loadDiagram(diagram, currentIndex);
                      }
                    }, 100);
                  }
                })
                .catch((error) => {
                  console.error("Mermaid rendering error:", error);
                  if (elementRef && elementRef.parentNode) {
                    tryFallbackRender(elementRef, content, error);
                  }
                });
            }, 100); // Increased delay to ensure DOM is stable
          }
        } else {
          // For markdown files, just display the content
          const container = document.createElement("div");
          container.className = "diagram-container";

          const title = document.createElement("div");
          title.className = "diagram-title";
          title.textContent = diagram.name;

          const pre = document.createElement("pre");
          pre.style.whiteSpace = "pre-wrap";
          pre.style.fontFamily = "monospace";
          pre.textContent = content;

          container.appendChild(title);
          container.appendChild(pre);
          mainContent.appendChild(container);
        }
      }

      // Fallback render method
      function tryFallbackRender(
        diagramElement,
        content,
        originalError = null
      ) {
        console.log("Using fallback render method");

        // Clear the element
        diagramElement.innerHTML = "";

        // Create a new element with the content
        const preElement = document.createElement("pre");
        preElement.className = "mermaid";
        preElement.textContent = content;
        diagramElement.appendChild(preElement);

        // Try to initialize Mermaid on this element
        try {
          mermaid.init(undefined, preElement);
          console.log("Fallback render successful");
        } catch (error) {
          console.error("Fallback render failed:", error);
          diagramElement.innerHTML = `
             <div class="error">
               <strong>Mermaid rendering failed:</strong> ${
                 originalError ? originalError.message : error.message
               }
               <br><br>
               <strong>Content:</strong>
               <pre style="font-size: 12px; margin-top: 10px; background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto;">${content}</pre>
             </div>
           `;
        }
      }

      // Initialize
      loadDiagrams();
    </script>
  </body>
</html>
